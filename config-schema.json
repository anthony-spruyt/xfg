{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/anthony-spruyt/xfg/config-schema.json",
  "title": "xfg Configuration",
  "description": "Configuration file for xfg CLI tool that syncs JSON, YAML, or text config files across multiple Git repositories",
  "type": "object",
  "required": ["files", "repos"],
  "properties": {
    "files": {
      "type": "object",
      "description": "Map of target filenames to their configurations. Each file is synced to all repos by default.",
      "minProperties": 1,
      "additionalProperties": {
        "$ref": "#/definitions/fileConfig"
      }
    },
    "repos": {
      "type": "array",
      "description": "List of repository configurations",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/repo"
      }
    },
    "prOptions": {
      "$ref": "#/definitions/prOptions",
      "description": "Global PR merge options. Can be overridden per-repo."
    }
  },
  "definitions": {
    "fileConfig": {
      "type": "object",
      "description": "Configuration for a single file to sync",
      "properties": {
        "content": {
          "oneOf": [
            {
              "type": "object",
              "description": "Object content for JSON/YAML output files (.json, .yaml, .yml)",
              "additionalProperties": true
            },
            {
              "type": "string",
              "description": "String content for text files, or file reference (@path/to/file) to load content from an external file"
            },
            {
              "type": "array",
              "items": { "type": "string" },
              "description": "Lines array for text file output with merge strategy support"
            }
          ],
          "description": "File content. Object for JSON/YAML files, string or string[] for text files. Use @path/to/file to reference external template files (paths relative to config file). Supports ${VAR} env interpolation; use $${VAR} to output literal ${VAR}. Omit for empty file."
        },
        "mergeStrategy": {
          "type": "string",
          "enum": ["replace", "append", "prepend"],
          "default": "replace",
          "description": "Array merge strategy for this file. 'replace' replaces arrays, 'append' adds overlay after base, 'prepend' adds overlay before base. Default: replace"
        },
        "createOnly": {
          "type": "boolean",
          "default": false,
          "description": "If true, only create this file if it doesn't already exist in the target repo. Useful for files like .trivyignore or .prettierignore where you want to provide defaults but let repos customize. Default: false"
        },
        "header": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single comment line"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Multiple comment lines"
            }
          ],
          "description": "Comment line(s) added at the top of YAML output files. Each line gets a '# ' prefix. Ignored for JSON files."
        },
        "schemaUrl": {
          "type": "string",
          "description": "URL for yaml-language-server schema directive. Adds '# yaml-language-server: $schema=<url>' at the top of YAML files. Ignored for JSON files."
        },
        "executable": {
          "type": "boolean",
          "description": "Mark the file as executable via git update-index --add --chmod=+x. Shell scripts (.sh) are auto-executable unless explicitly set to false. Non-.sh files can be marked executable by setting to true."
        }
      }
    },
    "repo": {
      "type": "object",
      "description": "Repository configuration",
      "required": ["git"],
      "properties": {
        "git": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single Git repository URL"
            },
            {
              "type": "array",
              "description": "Multiple Git repository URLs (each becomes a separate sync target)",
              "items": {
                "type": "string"
              },
              "minItems": 1
            }
          ],
          "description": "Git repository URL(s). Supports GitHub (git@github.com:owner/repo.git, https://github.com/owner/repo.git) and Azure DevOps formats"
        },
        "files": {
          "type": "object",
          "description": "Per-repo file overrides or exclusions. Keys must reference files defined in the root 'files' object. Set to false to exclude a file from this repo.",
          "additionalProperties": {
            "oneOf": [
              {
                "type": "boolean",
                "const": false,
                "description": "Set to false to exclude this file from this repo"
              },
              {
                "$ref": "#/definitions/repoFileOverride"
              }
            ]
          }
        },
        "prOptions": {
          "$ref": "#/definitions/prOptions",
          "description": "Per-repo PR merge options. Overrides global prOptions."
        }
      }
    },
    "prOptions": {
      "type": "object",
      "description": "PR merge behavior options",
      "properties": {
        "merge": {
          "type": "string",
          "enum": ["manual", "auto", "force"],
          "default": "auto",
          "description": "Merge mode: 'manual' leaves PR open for review, 'auto' enables auto-merge when checks pass, 'force' bypasses requirements using admin privileges. Default: auto"
        },
        "mergeStrategy": {
          "type": "string",
          "enum": ["merge", "squash", "rebase"],
          "default": "squash",
          "description": "How to merge the PR: 'merge' creates a merge commit, 'squash' squashes all commits, 'rebase' rebases commits onto base. Default: squash"
        },
        "deleteBranch": {
          "type": "boolean",
          "default": true,
          "description": "Delete the source branch after merge completes. Default: true"
        },
        "bypassReason": {
          "type": "string",
          "description": "Reason for bypassing policies (Azure DevOps only, required when merge=force)"
        }
      }
    },
    "repoFileOverride": {
      "type": "object",
      "description": "Per-repo override for a specific file",
      "properties": {
        "content": {
          "oneOf": [
            {
              "type": "object",
              "description": "Object content overlay for JSON/YAML files. Use $arrayMerge directive to control array merging.",
              "additionalProperties": true
            },
            {
              "type": "string",
              "description": "String content for text files, or file reference (@path/to/file) to load content from an external file"
            },
            {
              "type": "array",
              "items": { "type": "string" },
              "description": "Lines array for text files (uses merge strategy: replace/append/prepend)"
            }
          ],
          "description": "Content overlay merged onto the file's base content. Use @path/to/file to reference external template files. Must match the content type of the root file definition."
        },
        "override": {
          "type": "boolean",
          "default": false,
          "description": "If true, use only this content and skip merging with base. Default: false"
        },
        "createOnly": {
          "type": "boolean",
          "description": "Override the root-level createOnly setting for this specific repo"
        },
        "header": {
          "oneOf": [
            {
              "type": "string",
              "description": "Single comment line"
            },
            {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "Multiple comment lines"
            }
          ],
          "description": "Override the root-level header for this specific repo"
        },
        "schemaUrl": {
          "type": "string",
          "description": "Override the root-level schemaUrl for this specific repo"
        },
        "executable": {
          "type": "boolean",
          "description": "Override the root-level executable setting for this specific repo. Set to true to mark executable, or false to disable auto-executable behavior for .sh files."
        }
      }
    }
  }
}
