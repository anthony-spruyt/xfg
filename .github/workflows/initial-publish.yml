name: Initial Publish

# Manual workflow for first-time npm publish (before OIDC trust is established)
# After this succeeds, configure OIDC trusted publisher and use regular CI releases

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (don't actually publish)"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Publish to npm (dry run)
        if: inputs.dry_run == true
        run: npm publish --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: inputs.dry_run == false
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Summary
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$DRY_RUN" == "true" ]; then
            echo "**Dry run completed** - no package was published" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Package published successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to https://www.npmjs.com/package/@aspruyt/xfg/access" >> $GITHUB_STEP_SUMMARY
            echo "2. Configure OIDC trusted publisher for anthony-spruyt/xfg" >> $GITHUB_STEP_SUMMARY
            echo "3. Future releases will use the regular CI workflow with OIDC" >> $GITHUB_STEP_SUMMARY
          fi
